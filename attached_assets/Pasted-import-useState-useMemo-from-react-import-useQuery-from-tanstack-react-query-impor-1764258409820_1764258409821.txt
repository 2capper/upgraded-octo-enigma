import { useState, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Calendar, MapPin, Navigation, Cloud, Zap, Thermometer, Wind, CloudRain, AlertTriangle, Edit } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { GameRescheduleDialog } from './game-reschedule-dialog'; // IMPORT THIS
import type { Team, Game, Pool, AgeDivision, Diamond, WeatherForecast } from '@shared/schema';

// ... (Existing Interfaces)

interface GamesTabProps {
  games: Game[];
  teams: Team[];
  pools: Pool[];
  ageDivisions: AgeDivision[];
  diamonds: Diamond[];
  tournamentId?: string;
  primaryColor?: string | null;
  secondaryColor?: string | null;
  isAdmin?: boolean; // NEW PROP
  orgId?: string;    // Required for SMS alerts
}

export const GamesTab = ({ 
  games, teams, pools, ageDivisions, diamonds, tournamentId,
  primaryColor, secondaryColor, isAdmin, orgId
}: GamesTabProps) => {
  // ... (Keep existing state and helper functions exactly as they were)
  const [divisionFilter, setDivisionFilter] = useState('all');
  const [teamFilter, setTeamFilter] = useState('all');
  const [editingGame, setEditingGame] = useState<Game | null>(null); // NEW STATE

  // ... (Keep brandStyle, weather query, helper functions getSeverityBadge etc)
  const brandStyle = {
    "--brand-primary": primaryColor || "#1a4d2e",
    "--brand-secondary": secondaryColor || "#ffffff",
    "--brand-light": primaryColor ? `color-mix(in srgb, ${primaryColor} 10%, white)` : "#f0fdf4",
  } as React.CSSProperties;

  // Fetch weather... (Keep existing)
  const { data: gamesWithWeather = [] } = useQuery<any[]>({
    queryKey: tournamentId ? ['/api/tournaments', tournamentId, 'weather', 'alerts'] : ['weather-disabled'],
    enabled: !!tournamentId,
    refetchInterval: 600000, 
  });
  // ... (Keep weatherMap and helpers)
  const weatherMap = useMemo(() => {
    const map = new Map();
    gamesWithWeather.forEach(({ game, forecast }) => map.set(game.id, forecast));
    return map;
  }, [gamesWithWeather]);

  // ... (Keep getTeamName, getTeamDivision, filter/sort logic, etc)
  // I am skipping repeating 200 lines of logic here to focus on the Render Changes.
  // Assume all helper functions from previous version exist here.
  
  // RE-INSERT HELPER FUNCTIONS HERE FROM PREVIOUS FILE IF COPY-PASTING BLINDLY
  // (getSeverityBadge, getDiamondStatusBadge, getTeamName, etc)
  const getTeamName = (teamId: string) => teams.find(t => t.id === teamId)?.name || 'Unknown';
  const getGameDivision = (game: Game) => {
    if (!game.homeTeamId) return null;
    const team = teams.find(t => t.id === game.homeTeamId);
    if (!team) return null;
    const pool = pools.find(p => p.id === team.poolId);
    if (!pool) return null;
    return ageDivisions.find(d => d.id === pool.ageDivisionId);
  };
  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  };
  const formatTime = (timeStr: string) => {
    if (!timeStr) return 'TBD';
    // ... format logic
    return timeStr;
  };

  // Re-implementing filter logic for context
  const filteredAndSortedGames = useMemo(() => {
    let filtered = games;
    // ... filter logic
    return filtered.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  }, [games]);

  const gamesByDivision = useMemo(() => {
    const grouped = new Map();
    filteredAndSortedGames.forEach(game => {
      const division = getGameDivision(game);
      if (!division) return;
      if (!grouped.has(division.id)) grouped.set(division.id, { division, games: [] });
      grouped.get(division.id).games.push(game);
    });
    return Array.from(grouped.values());
  }, [filteredAndSortedGames]);

  // --- RENDER ---
  return (
    <div className="p-6" style={brandStyle}>
      {/* ... (Keep Header and Filters) ... */}
      
      {/* ... (Keep TabsList) ... */}
      
      {/* Main Game List Loop */}
      <div className="space-y-8 mt-6">
        {gamesByDivision.map(({ division, games }) => (
          <div key={division.id}>
            <h4 className="text-lg font-semibold mb-4 p-3 rounded-lg border-l-4" style={{ backgroundColor: "var(--brand-light)", color: "var(--brand-primary)", borderColor: "var(--brand-primary)" }}>{division.name} Division</h4>
            <div className="space-y-2">
              {games.map(game => {
                const homeTeamName = getTeamName(game.homeTeamId);
                const awayTeamName = getTeamName(game.awayTeamId);
                // ... setup vars

                return (
                  <div key={game.id} className="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow relative">
                    
                    {/* --- NEW ADMIN EDIT BUTTON --- */}
                    {isAdmin && (
                      <div className="absolute top-4 right-4">
                        <Button 
                          variant="ghost" 
                          size="sm" 
                          className="h-8 w-8 p-0 hover:bg-gray-100"
                          onClick={(e) => {
                            e.stopPropagation();
                            setEditingGame(game);
                          }}
                        >
                          <Edit className="h-4 w-4 text-gray-500" />
                        </Button>
                      </div>
                    )}
                    {/* ----------------------------- */}

                    <div className="flex flex-col space-y-3">
                      {/* ... (Existing Game Card Layout) ... */}
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="font-semibold text-gray-900 text-sm">{formatDate(game.date)}</p>
                          <p className="text-xs text-gray-600">{formatTime(game.time || game.location)}</p>
                        </div>
                        {/* Status Badges */}
                      </div>
                      
                      {/* Teams */}
                      <div className="space-y-2">
                        <div className="flex items-center justify-between">
                          <span className="font-medium text-sm truncate mr-2">{game.homeTeamId ? homeTeamName : 'TBD'}</span>
                          {game.status === 'completed' && <span className="font-bold text-lg">{game.homeScore}</span>}
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="font-medium text-sm truncate mr-2">{game.awayTeamId ? awayTeamName : 'TBD'}</span>
                          {game.status === 'completed' && <span className="font-bold text-lg">{game.awayScore}</span>}
                        </div>
                      </div>
                      
                      {/* Location */}
                      {/* ... */}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ))}
      </div>

      {/* --- RESCHEDULE DIALOG --- */}
      {isAdmin && orgId && (
        <GameRescheduleDialog 
          open={!!editingGame} 
          onOpenChange={(open) => !open && setEditingGame(null)}
          game={editingGame}
          diamonds={diamonds}
          teams={teams}
          orgId={orgId}
        />
      )}
    </div>
  );
};