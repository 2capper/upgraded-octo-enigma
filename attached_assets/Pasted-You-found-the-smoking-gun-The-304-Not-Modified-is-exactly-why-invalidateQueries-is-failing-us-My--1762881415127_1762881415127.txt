You found the smoking gun. The 304 Not Modified is exactly why invalidateQueries is failing us.

My last plan was wrong. Your analysis is 100% correct. Here's the sequence:

We call invalidateQueries on pools.

react-query asks the server for fresh pools.

The server (correctly) says, "The pools haven't changed, use your cache," and sends a 304.

react-query doesn't get new data, so it never triggers a re-render of the DragScheduleBuilder component.

The component's useMemo hook runs with stale pools and fresh matchups (from your setQueryData), which causes the filter to fail and show "No matchups found."

This is a classic, subtle cache bug.

Your conclusion is the right one. The "Atomic Cache" solution (my Iteration 25) is the only way to fix this. We must manually force-feed both pieces of data into the cache at the same time.

ðŸš€ Iteration 25 (Confirmed): The "Atomic Cache" Fix
This is the definitive plan.

1. Backend Mandate (The "Source of Truth")

Your POST /api/tournaments/:tournamentId/generate-matchups endpoint must return an object containing both the new matchups and the (potentially unchanged) pools.

Backend Response:

JSON

{ 
  "matchups": [...],
  "pools": [...] 
}
2. Frontend Mandate (The "Atomic Update")

In src/components/PoolAssignment.tsx, your generateMutation.onSuccess handler must use setQueryData for both keys.

This is the final, correct code for your onSuccess handler:

JavaScript

Â  Â  onSuccess: (data) => {
Â  Â  Â  // 'data' is now { matchups: [], pools: [] } from your API
Â  Â  Â  const { matchups, pools } = data;

Â  Â  Â  // --- THIS IS THE ATOMIC FIX ---
Â  Â  Â Â 
Â  Â  Â  // 1. MANUALLY update the matchups cache. (Instant)
Â  Â  Â  queryClient.setQueryData(
Â  Â  Â  Â  ['/api/tournaments', tournamentId, 'matchups'],
Â  Â  Â  Â  matchups
Â  Â  Â  );
Â  Â  Â Â 
Â  Â  Â  // 2. MANUALLY update the pools cache. (Instant)
Â  Â  Â  // This bypasses the 304 error and forces a re-render
Â  Â  Â  // with fresh, synchronized data.
Â  Â  Â  queryClient.setQueryData(
Â  Â  Â  Â  [`/api/tournaments/${tournamentId}/pools`], // Using your queryKey
Â  Â  Â  Â  pools
Â  Â  Â  );
Â  Â  Â Â 
Â  Â  Â  // 3. Invalidate 'games' just to clear them.
Â  Â  Â  queryClient.invalidateQueries({Â 
Â  Â  Â  Â  queryKey: ['/api/tournaments', tournamentId, 'games']
Â  Â  Â  });
Â  Â  Â  // --- END FIX ---

Â  Â  Â  toast({
Â  Â  Â  Â  title: "Matchups Created!",
Â  Â  Â  Â  description: `Scroll down to see the schedule builder.`,
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // 4. Scroll to scheduler
Â  Â  Â  if (onMatchupsGenerated) {
Â  Â  Â  Â  onMatchupsGenerated();
Â  Â  Â  }
Â  Â  },
This is the one. It eliminates the race condition and the 304 stale-cache bug. This will work. Implement this.